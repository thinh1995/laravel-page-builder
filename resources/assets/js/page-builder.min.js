class PageBuilder{static config={renderBlockUrl:"/page-builder/render-block",previewUrl:"/page-builder/preview",previewContext:{}};static b64Decode(e){try{return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch(t){return console.error("Error:",t),""}}static blocksRendered(){}static beforePreview(){}static getBlockContent(e){return e.querySelector(".block-content")?.value||""}static async renderBlockItems(e,t,a,l){let r=document.createDocumentFragment();for(let i of a){let o=this.createBlockElement(e,i,await this.getBlockHtml(i.type,i.content));this.attachBlockEventListeners(e,o,i.locale),i.is_layout&&await this.setupLayoutBlock(e,i.locale,o,i.children),r.appendChild(o)}l.appendChild(r),this.blocksRendered()?.()}static createBlockElement(e,t,a){let l=document.createElement("div");return l.dataset.pageBuilderId=e,l.dataset.type=t.type,l.dataset.blockId=t.block_id,l.dataset.isLayout=t.is_layout,l.innerHTML=a,l}static attachBlockEventListeners(e,t,a){t.querySelector(".block-remove")?.addEventListener("click",()=>{t.remove(),this.updateBlockItems(e,a)}),t.querySelector(".block-content")?.addEventListener("input",()=>this.updateBlockItems(e,a),{passive:!0})}static async addBlockToColumn(e){let t=e.item;if(e.from.id.startsWith("block-list-")&&(t.innerHTML=await PageBuilder.getBlockHtml(t.dataset.type),t.classList.remove("block"),t.classList.add("sortable-dropped"),t.getAttribute("data-is-layout"))){let a=t.getAttribute("data-page-builder-id"),l=e.to.closest(".sortable-container").getAttribute("data-locale");t.querySelectorAll(".sortable-column").forEach(e=>{Sortable.create(e,{group:{name:`editor-${a}`,put:[`block-list-${a}`,`editor-${a}`]},animation:150,handle:".block-title",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onAdd:PageBuilder.addBlockToColumn,onEnd(){PageBuilder.removeHighlightDroppableAreas(),PageBuilder.updateBlockItems(a,l)},onStart:()=>PageBuilder.highlightDroppableAreas(a),onOver:t=>PageBuilder.handleDragOver(t,e),onOut:()=>PageBuilder.removeHighlight(e)})})}PageBuilder.attachBlockEventListeners(t.dataset.pageBuilderId,t,e.to.closest(".sortable-container").dataset.locale),PageBuilder.blocksRendered()?.(),t.classList.remove("sortable-dropped")}static async setupLayoutBlock(e,t,a,l){let r=a.querySelectorAll(".sortable-column");await Promise.all(Array.from(r).map(async(a,r)=>{let i=l.filter(e=>e.column_index===r);i.length&&await this.renderBlockItems(e,t,i,a),Sortable.create(a,{group:{name:`editor-${e}`,put:[`block-list-${e}`,`editor-${e}`]},animation:150,handle:".block-title",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onAdd:this.addBlockToColumn,onEnd:()=>{this.removeHighlightDroppableAreas(),this.updateBlockItems(e,t)},onStart:()=>this.highlightDroppableAreas(e),onOver:e=>this.handleDragOver(e,a),onOut:()=>this.removeHighlight(a)})}))}static updateIframeSize(e){let t=document.getElementById("preview-iframe"),a=document.getElementById("iframe-container"),l={desktop:{width:"100%",maxWidth:"none"},tablet:{width:"768px",maxWidth:"768px"},mobile:{width:"375px",maxWidth:"375px"}}[e];l&&(t.style.width=l.width,a.style.width=l.width,a.style.maxWidth=l.maxWidth)}static updateBlockItems(e,t){let a=document.getElementById(e).querySelector(`.sortable-container[data-locale="${t}"]`),l=this.getBlockItems(a);return document.getElementById(`blocks-${t}-${e}`).value=JSON.stringify(l),l}static async getBlockHtml(e,t=""){try{let a=await fetch(this.config.renderBlockUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({type:e,content:t})}),{data:l}=await a.json();return this.b64Decode(l)}catch(r){return console.error("Error:",r),""}}static getBlockItems(e,t=0){return e?.childElementCount?Array.from(e.children).map((e,a)=>{let l=e.querySelector(".block-editor");if(!l)return null;let r=l.closest("[data-type]"),i=r.dataset.isLayout?Array.from(l.querySelector(".row").children).flatMap((e,t)=>this.getBlockItems(e.querySelector(".sortable-column"),t)):[];return{block_id:r.dataset.blockId,type:r.dataset.type,content:this.getBlockContent(l),column_index:t,order:a,children:i}}).filter(Boolean):[]}static highlightDroppableAreas(e){document.querySelectorAll(`.sortable-container[data-page-builder-id="${e}"]`).forEach(e=>{e.classList.add("droppable-highlight")}),document.querySelectorAll(`[data-page-builder-id="${e}"][data-is-layout="true"] .sortable-column`).forEach(e=>{e.classList.add("droppable-highlight")})}static removeHighlightDroppableAreas(){document.querySelectorAll(".droppable-highlight").forEach(e=>{e.classList.remove("droppable-highlight")})}static handleDragOver(e,t){t.classList.add("droppable-highlight")}static removeHighlight(e){e.classList.remove("droppable-highlight")}static initBlockList(e){let t=document.getElementById(`block-list-${e}`);t&&Sortable.create(t,{group:{name:`block-list-${e}`,put:!1,pull:"clone"},sort:!1,animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onStart:()=>this.highlightDroppableAreas(e),onEnd:()=>this.removeHighlightDroppableAreas()})}static async initBlockItems(e,t,a){let l=document.getElementById(e).querySelector(`.sortable-container[data-locale="${t}"]`);await this.renderBlockItems(e,t,a,l)}static initEditors(e){let t=document.getElementById(e);t.querySelectorAll(".sortable-container").forEach(t=>{Sortable.create(t,{group:{name:`editor-${e}`,put:[`block-list-${e}`,`editor-${e}`]},animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",handle:".block-title",onStart:()=>this.highlightDroppableAreas(e),onAdd:this.addBlockToColumn,onEnd:()=>{this.removeHighlightDroppableAreas(),this.updateBlockItems(e,t.getAttribute("data-locale"))},onOver:e=>this.handleDragOver(e,t),onOut:()=>this.removeHighlight(t)})})}static initPreview(e){let t=document.getElementById(e);t.querySelectorAll(".preview-btn").forEach(t=>{t.addEventListener("click",async()=>{let a=t.dataset.locale,l=this.updateBlockItems(e,a),r=document.getElementById("preview-iframe");this.beforePreview?.();try{let i=await fetch(this.config.previewUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({locale:a,blocks:l,context:this.config.previewContext})}),{data:o}=await i.json();r.srcdoc=this.b64Decode(o),document.getElementById("device-desktop").checked=!0,this.updateIframeSize("desktop")}catch(s){console.error("Error:",s)}})}),document.querySelectorAll('input[name="device-select"]').forEach(e=>{e.addEventListener("change",()=>this.updateIframeSize(document.querySelector('input[name="device-select"]:checked').value),{passive:!0})})}static initFormSubmit(e,t=[]){let a=document.getElementById(e).closest("form");a.addEventListener("submit",()=>{t.forEach(t=>this.updateBlockItems(e,t)),document.querySelectorAll('input[name="device-select"]').forEach(e=>e.disabled=!0)})}static async init(e,t,a){t=Array.isArray(t)?t:[t],this.initBlockList(e),this.initEditors(e),this.initPreview(e),this.initFormSubmit(e,t),await Promise.all(t.map(t=>a[t]?.length?this.initBlockItems(e,t,a[t]):null))}}